---
df_print: tibble
output:
  html_notebook:
    default
  pdf_document:
    keep_tex: yes
always_allow_html: yes
---

```{r census-acs-setup, echo = FALSE, warning=FALSE,message=FALSE,comment=FALSE}
library(plyr)
library(knitr)
library(rprojroot)
library(rgdal)
library(sp)
library(rgeos)
library(tigris)
library(leaflet)
library(ggthemes)
library(magrittr)
library(stringr)
library(downloader)
library(webshot)
library(htmltools)
library(gplots)
library(ggmap)
library(shiny)
library(htmlwidgets)
library(readxl)
library(acs)
library(RColorBrewer)
library(tidyverse)
library(miscgis)
library(operator.tools)
library(leaflet.extras)
library(viridisLite)
library(sf)
root <- rprojroot::is_rstudio_project
root_file <- root$make_fix_file()
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE)

```

### ACS Geo Set
This geoset is mixture of geography type including:

  * tracts, King County
  * combined tracts, each COO community individually and all three combined together
  * county subdivision, Seattle CCD
  
```{r census-acs, echo = TRUE}

# Setup the ACS geographies: King County (tracts), Seattle CCD (), COO Communities (tracts)
# -----------------------------------------------------------------------------

coo_geos_sf <- read_rds(root_file('1-data/4-interim/coo-geos-sf.rds')) 

get_geoid <- function(x,nm){
        x %>% filter(NAME %in% nm & !is.na(GEOID6)) %>% select(GEOID6) %>% unlist(use.names = FALSE) %>% as.numeric
}

tr_rv <- get_geoid(coo_geos_sf,'RV')
tr_wc <- get_geoid(coo_geos_sf,'WC')
tr_stkw <- get_geoid(coo_geos_sf,'STKW')
tr_coo <- get_geoid(coo_geos_sf, c('RV','WC','STKW'))

# King County (Puget Sound excluded)
tr_kc <- read_rds(root_file('1-data/4-interim/tr-kc-sf.rds')) %>% select(TRACTCE) %>% unlist(use.names = FALSE) %>% as.numeric




# Final Object: 2010-2014
coo_geo_acs <- c(
        acs::geo.make(state = "WA",county = "King"),
        acs::geo.make(state = "WA", county = "King",county.subdivision = "Seattle CCD"),
        acs::geo.make(state = "WA",county = "King", tract = tr_kc),
        acs::geo.make(state = "WA",county = "King", tract = tr_rv, combine = TRUE, combine.term = 'RV'),
        acs::geo.make(state = "WA",county = "King", tract =tr_wc, combine = TRUE, combine.term = 'WC'),
        acs::geo.make(state = "WA",county = "King", tract = tr_stkw, combine = TRUE, combine.term = 'STKW'),
        acs::geo.make(state = "WA",county = "King", tract = tr_coo, combine = TRUE, combine.term = 'COO')
) %>%  
        write_rds(root_file('1-data/4-interim/coo-geo-acs.rds'))


```

### Matching Tracts between the years

Census tract change over time and this must be accounted for before a temporal comparison be take place. Brown University's [Longitudinal Tract Database](http://www.s4.brown.edu/us2010/Researcher/LTDB.htm) provides "crosswalk" datasets that clarify which tract change from decade to decade and what type of change occurred (e.g., consolidation, split, many-to-many, none).

Using the 2000-2010 crosswalk, a customized set of ACS geographies is prepared to ensure that the data between observation periods are comparable. This dataset is included in this repository, but may also be downloaded [here](https://s4.ad.brown.edu/Projects/Diversity/Researcher/ltdb3.htm).


```{r census-2009-acs, echo=TRUE}

# Save an acs object
c(
        acs::geo.make(state = "WA",county = "King"),
        acs::geo.make(state = "WA", county = "King",county.subdivision = "Seattle CCD"),
        acs::geo.make(state = "WA",county = "King", tract = '*')
) %>%  
        write_rds(root_file('1-data/4-interim/coo-geo-2009-acs.rds'))

```
