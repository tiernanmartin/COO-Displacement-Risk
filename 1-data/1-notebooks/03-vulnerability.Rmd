---
df_print: tibble
output:
  html_notebook:
    code_folding: hide
  pdf_document:
    keep_tex: yes
always_allow_html: yes
---

```{r vuln-poc-setup, echo = FALSE, warning=FALSE,message=FALSE,comment=FALSE}
library(plyr)
library(knitr)
library(rprojroot)
library(rgdal)
library(sp)
library(rgeos)
library(tigris)
library(leaflet)
library(ggthemes)
library(magrittr)
library(stringr)
library(downloader)
library(webshot)
library(htmltools)
library(gplots)
library(ggmap)
library(shiny)
library(htmlwidgets)
library(readxl)
library(acs)
library(RColorBrewer)
library(tidyverse)
library(miscgis)
library(operator.tools)
library(leaflet.extras)
library(viridisLite)
library(sf)
root <- rprojroot::is_rstudio_project
root_file <- root$make_fix_file()
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE)
```

### Introduction

```{r vuln-colors}
green <- miscgis::miscgis_pals$tableau_cat[["green"]]
blue <- miscgis::miscgis_pals$tableau_cat[["blue"]]
orange <- miscgis::miscgis_pals$tableau_cat[["orange"]]
red <- miscgis::miscgis_pals$tableau_cat[["red"]]
teal <- miscgis::miscgis_pals$tableau_cat[["teal"]]
pal_rgb_4 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue")] %>% unlist %>% palette()
pal_rgb_4 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue")] %>% unlist %>% palette()
pal_rgb_6 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue","orange","purple")] %>% unlist %>% palette()
pal_rgb_6 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue","orange","purple")] %>% unlist %>% palette()
proj_light_grey <- col2hex("grey75")
proj_grey <- col2hex("grey50")
proj_dark_grey <- col2hex("grey25")
```

_NOTE: this text is placeholder and must be changed_

Census tracts were assigned a “vulnerability score” between 0 and 4, with a weight of 1 for each
of the following that is true:

  * Greater than XX% of households are renters
  * Greater than XX% of the population are communities of color
  * Greater than XX% of the population 25 years and older do not have a bachelor’s degree
  * Greater than XX% of households have incomes at or below at or below 80% of the HUDadjusted
median family income (MFI) [Note: HUD's FY2015 MFI for the
Seattle-Bellevue, WA HUD Metro FMR Area was $89,500.]

We defined vulnerable tracts as those with a vulnerability score of at least 3 out of 4.

### Population Belonging to A Community of Color (%), 2010-2014

#### Plot
```{r vuln-poc-acs}

# Download the Census table for the project's geographies
# -----------------------------------------------------------------------------

coo_geo_acs <- read_rds(root_file('1-data/4-interim/coo-geo-acs.rds'))

vuln_poc_tbl <- "B03002"  # census table code

if(!file.exists(root_file('1-data/4-interim/vuln-poc-orig-acs.rds'))){
        
        acs.fetch(endyear = 2014, geography = coo_geo_acs, 
                  table.number = vuln_poc_tbl) %>%
                write_rds(root_file('1-data/4-interim/vuln-poc-orig-acs.rds'))
        
}

vuln_poc_orig_acs <- read_rds(root_file('1-data/4-interim/vuln-poc-orig-acs.rds'))


# Process and save the data
# -----------------------------------------------------------------------------

if(!file.exists(root_file('1-data/4-interim/vuln-poc-acs.rds'))){
        vuln_poc_acs1 <- vuln_poc_orig_acs
        
        vuln_poc_tbl_guide <- 
                data.frame(terse = acs.colnames(vuln_poc_acs1),
                       pretty = acs.colnames(acs.fetch(endyear = 2014, 
                          geography = geo.make(us = TRUE), 
                          table.number = vuln_poc_tbl,col.names = 'pretty')))
        # Pull out the specific columns that are important
        
        get_col <- function(pattern){
                vuln_poc_tbl_guide %>% filter(str_detect(pretty,pattern)) %>% select(terse) %>% unlist(use.names = FALSE) %>% as.character()
        }
        
        total <- get_col('Total')
        
        white_not_hisp <- get_col('Not Hispanic or Latino: White alone')
        
        # Subtract white non-hispanic pop. from the total pop. (difference is the POC pop.)
        
        vuln_poc_acs2 <- vuln_poc_acs1[, total] - vuln_poc_acs1[, white_not_hisp] 
                        
        acs.colnames(vuln_poc_acs2) <- "POC"
                        
        vuln_poc_acs3 <- cbind(vuln_poc_acs1, vuln_poc_acs2)
        
        # Find the proportion of People of Color to the Total population
        
        acs_col_pct_poc <-  
                acs::apply(X = vuln_poc_acs3[,'POC'],
                           MARGIN = 1,
                           FUN = divide.acs,
                           denominator = vuln_poc_acs3[,total],
                           method = "proportion",
                           verbose = FALSE)
        acs.colnames(acs_col_pct_poc) <- 'PCT_POC'
        
        # Save the object

acs_col_pct_poc %>% saveRDS(root_file('1-data/4-interim/vuln-poc-acs.rds'))
}

vuln_poc_acs <- read_rds(root_file('1-data/4-interim/vuln-poc-acs.rds'))


# Plot the data
# -----------------------------------------------------------------------------

# plot(vuln_poc_acs)

plot(vuln_poc_acs[order(estimate(vuln_poc_acs)),1])
# plot(vuln_poc_acs[order(standard.error(vuln_poc_acs)),1])


```

```{r vuln-poc-sf}

if(!file.exists(root_file('1-data/4-interim/vuln-poc-sf.rds'))){
        # Read in the `sf` object and re-order the records to by `JOIN_ID` 
# -----------------------------------------------------------------------------

coo_geos_sf <- 
        read_rds(root_file('1-data/4-interim/coo-geos-sf.rds'))

coo_geos_sf_ordered <- coo_geos_sf %>% arrange(desc(JOIN_ID)) %>% select(-JOIN_ID)

#
# Convert the `acs` object into a dataframe, join to sf object
# -----------------------------------------------------------------------------

coo_vuln_poc_sf <- 
        data.frame(
                geography(vuln_poc_acs)["NAME"],
                geography(vuln_poc_acs)["tract"],
                estimate(vuln_poc_acs), 
                1.645 * standard.error(vuln_poc_acs)) %>% 
        `colnames<-`(., c("NAME","GEOID6", "POC_PCT_EST","POC_PCT_MOE")) %>% 
        mutate(JOIN_ID = case_when(.$NAME %in% 'King County, Washington' ~ 'KC',
                                  .$NAME %in% 'Seattle CCD, King County, Washington' ~ 'SEACCD',
                                  !is.na(.$GEOID6) ~ .$GEOID6),
               UPPER = POC_PCT_EST + POC_PCT_MOE, 
               LOWER = POC_PCT_EST - POC_PCT_MOE, 
               POC_PCT_UPPER = if_else(UPPER > 1, 1, UPPER), 
               POC_PCT_LOWER = if_else(LOWER < 0, 0, LOWER)) %>% 
        select(JOIN_ID,everything(),-NAME,-GEOID6,-UPPER,-LOWER) %>% 
        arrange(desc(JOIN_ID)) %>%
        bind_cols(coo_geos_sf_ordered) %>% 
        st_sf()

#
# Save the object
# -----------------------------------------------------------------------------
coo_vuln_poc_sf %>% write_rds(root_file('1-data/4-interim/vuln-poc-sf.rds'))
}

coo_vuln_poc_sf <-  read_rds(root_file('1-data/4-interim/vuln-poc-sf.rds'))


```

#### Maps

These maps show the proportion of the population that belongs to a community of color for each census tract in Seattle CCD.

##### Seattle CCD 
```{r vuln-poc-seaccd-map}

tr <- 
        coo_vuln_poc_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL)

tr_comm <- 
        coo_vuln_poc_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL &!is.na(NAME))

comm <- coo_vuln_poc_sf %>% 
        filter(GEOGRAPHY == 'community')

comm_cntr <- comm %>% mutate(geometry = st_centroid(comm))

pal_poc <- colorNumeric(viridis(256, option = "C"),tr$POC_PCT_EST)

myLfltGrey() %>% 
        addPolygons(data = as(tr,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_poc(POC_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "People of<br>Color",
                  position = 'topright',
                  pal = pal_poc, 
                  values = tr$POC_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

#####COO Communities
```{r vuln-poc-comm-map}
myLfltGrey() %>% 
        addPolygons(data = as(tr_comm,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_poc(POC_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "People of<br>Color",
                  position = 'topright',
                  pal = pal_poc, 
                  values = tr$POC_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

### Population in Renter-Occupied Housing Units (%), 2010-2014
```{r vuln-rent-acs}

# Download the Census table for the project's geographies
# -----------------------------------------------------------------------------

if(!exists('coo_geo_acs')){coo_geo_acs <- read_rds(root_file('1-data/4-interim/coo-geo-acs.rds'))}

vuln_rent_tbl <- "B25033"  # census table code

if(!file.exists(root_file('1-data/4-interim/vuln-rent-orig-acs.rds'))){
        
        acs.fetch(endyear = 2014, geography = coo_geo_acs, 
                  table.number = vuln_rent_tbl) %>%
                write_rds(root_file('1-data/4-interim/vuln-rent-orig-acs.rds'))
        
}

vuln_rent_orig_acs <- read_rds(root_file('1-data/4-interim/vuln-rent-orig-acs.rds'))


# Process and save the data
# -----------------------------------------------------------------------------

if(!file.exists(root_file('1-data/4-interim/vuln-rent-acs.rds'))){
        vuln_rent_acs1 <- vuln_rent_orig_acs
        
        vuln_rent_tbl_guide <- 
                data.frame(terse = acs.colnames(vuln_rent_acs1),
                       pretty = acs.colnames(acs.fetch(endyear = 2014, 
                          geography = geo.make(us = TRUE), 
                          table.number = vuln_rent_tbl,col.names = 'pretty')))
        # Pull out the specific columns that are important
        
        get_col <- function(pattern){
                vuln_rent_tbl_guide %>% filter(str_detect(pretty,pattern)) %>% select(terse) %>% unlist(use.names = FALSE) %>% as.character()
        }
        
        total <- get_col('Total:')
        
        rent <- get_col('Renter occupied:$')
        
        # Find the proportion of renters to the Total population
        
        acs_col_pct_rent <-  
                acs::apply(X = vuln_rent_acs1[,rent],
                           MARGIN = 1,
                           FUN = divide.acs,
                           denominator = vuln_rent_acs1[,total],
                           method = "proportion",
                           verbose = FALSE)
        acs.colnames(acs_col_pct_rent) <- 'PCT_RENT'
        
        # Save the object

acs_col_pct_rent %>% saveRDS(root_file('1-data/4-interim/vuln-rent-acs.rds'))
}

vuln_rent_acs <- read_rds(root_file('1-data/4-interim/vuln-rent-acs.rds'))


# Plot the data
# -----------------------------------------------------------------------------

# plot(vuln_rent_acs)

plot(vuln_rent_acs[order(estimate(vuln_rent_acs)),1])
# plot(vuln_rent_acs[order(standard.error(vuln_rent_acs)),1])

```

```{r vuln-rent-sf}

if(!file.exists(root_file('1-data/4-interim/vuln-rent-sf.rds'))){
        # Read in the `sf` object and re-order the records to by `JOIN_ID` 
# -----------------------------------------------------------------------------

if(!exists('coo_geos_sf')){coo_geos_sf <- read_rds(root_file('1-data/4-interim/coo-geos-sf.rds'))}        
        
coo_geos_sf_ordered <- coo_geos_sf %>% arrange(JOIN_ID) %>% select(-JOIN_ID)

#
# Convert the `acs` object into a dataframe, join to sf object
# -----------------------------------------------------------------------------

coo_vuln_rent_sf <- 
        data.frame(
                geography(vuln_rent_acs)["NAME"],
                geography(vuln_rent_acs)["tract"],
                estimate(vuln_rent_acs), 
                1.645 * standard.error(vuln_rent_acs)) %>% 
        `colnames<-`(., c("NAME","GEOID6", "RENT_PCT_EST","RENT_PCT_MOE")) %>% 
        mutate(JOIN_ID = case_when(.$NAME %in% 'King County, Washington' ~ 'KC',
                                  .$NAME %in% 'Seattle CCD, King County, Washington' ~ 'SEACCD',
                                  !is.na(.$GEOID6) ~ .$GEOID6),
               UPPER = RENT_PCT_EST + RENT_PCT_MOE, 
               LOWER = RENT_PCT_EST - RENT_PCT_MOE, 
               RENT_PCT_UPPER = if_else(UPPER > 1, 1, UPPER), 
               RENT_PCT_LOWER = if_else(LOWER < 0, 0, LOWER)) %>% 
        select(JOIN_ID,everything(),-NAME,-GEOID6,-UPPER,-LOWER) %>% 
        arrange(desc(JOIN_ID)) %>%
        bind_cols(coo_geos_sf_ordered) %>% 
        st_sf()

#
# Save the object
# -----------------------------------------------------------------------------
coo_vuln_rent_sf %>% write_rds(root_file('1-data/4-interim/vuln-rent-sf.rds'))
}

coo_vuln_rent_sf <-  read_rds(root_file('1-data/4-interim/vuln-rent-sf.rds'))


```

##### Seattle CCD 
```{r vuln-rent-seaccd-map}

tr <- 
        coo_vuln_rent_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL)

tr_comm <- 
        coo_vuln_rent_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL &!is.na(NAME))

comm <- coo_vuln_rent_sf %>% 
        filter(GEOGRAPHY == 'community')

comm_cntr <- comm %>% mutate(geometry = st_centroid(comm))

pal_rent <- colorNumeric(viridis(256, option = "C"),tr$RENT_PCT_EST)

myLfltGrey() %>% 
        addPolygons(data = as(tr,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_rent(RENT_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "Renters",
                  position = 'topright',
                  pal = pal_rent, 
                  values = tr$RENT_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

#####COO Communities
```{r vuln-rent-comm-map}
myLfltGrey() %>% 
        addPolygons(data = as(tr_comm,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_poc(RENT_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "Renters",
                  position = 'topright',
                  pal = pal_poc, 
                  values = tr$RENT_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

### Adults 25+ With Less Than a Bachelor Degree (%), 2010-2014
```{r vuln-lt-bach-acs}

# Download the Census table for the project's geographies
# -----------------------------------------------------------------------------

if(!exists('coo_geo_acs')){coo_geo_acs <- read_rds(root_file('1-data/4-interim/coo-geo-acs.rds'))}

vuln_lt_bach_tbl <- "B15003"  # census table code

if(!file.exists(root_file('1-data/4-interim/vuln-lt-bach-orig-acs.rds'))){
        
        acs.fetch(endyear = 2014, geography = coo_geo_acs, 
                  table.number = vuln_lt_bach_tbl) %>%
                write_rds(root_file('1-data/4-interim/vuln-lt-bach-orig-acs.rds'))
        
}

vuln_lt_bach_orig_acs <- read_rds(root_file('1-data/4-interim/vuln-lt-bach-orig-acs.rds'))


# Process and save the data
# -----------------------------------------------------------------------------

if(!file.exists(root_file('1-data/4-interim/vuln-lt-bach-acs.rds'))){
        vuln_lt_bach_acs1 <- vuln_lt_bach_orig_acs
        
        vuln_lt_bach_tbl_guide <- 
                data.frame(terse = acs.colnames(vuln_lt_bach_acs1),
                       pretty = acs.colnames(acs.fetch(endyear = 2014, 
                          geography = geo.make(us = TRUE), 
                          table.number = vuln_lt_bach_tbl,col.names = 'pretty')))
        # Pull out the specific columns that are important
        
        get_col <- function(pattern){
                vuln_lt_bach_tbl_guide %>% filter(str_detect(pretty,pattern)) %>% select(terse) %>% unlist(use.names = FALSE) %>% as.character()
        }
        
        total <- get_col('Total:')
        
        bach_plus <- get_col('Bachelor|Master|Professional|Doctorate')
        
        # Add all pops with bach. or higher
        
        acs_col_bach_plus <- 
                acs::apply(X = vuln_lt_bach_acs1[,bach_plus],
                           MARGIN = 2,
                           FUN = sum,
                           verbose = FALSE)
        
        acs.colnames(acs_col_bach_plus) <- "BACH_PLUS"
        
        acs_col_lt_bach <- vuln_lt_bach_acs1[,total] - acs_col_bach_plus[,"BACH_PLUS"]
        
        acs.colnames(acs_col_lt_bach) <- "LT_BACH"
       
        # Find the proportion of renters to the Total population
        acs_col_pct_lt_bach <-  
                acs::apply(X = acs_col_lt_bach[,"LT_BACH"],
                           MARGIN = 1,
                           FUN = divide.acs,
                           denominator = vuln_lt_bach_acs1[,total],
                           method = "proportion",
                           verbose = FALSE)
        
        acs.colnames(acs_col_pct_lt_bach) <- 'PCT_LT_BACH'
        
        # Save the object

acs_col_pct_lt_bach %>% saveRDS(root_file('1-data/4-interim/vuln-lt-bach-acs.rds'))
}

vuln_lt_bach_acs <- read_rds(root_file('1-data/4-interim/vuln-lt-bach-acs.rds'))


# Plot the data
# -----------------------------------------------------------------------------

# plot(vuln_lt_bach_acs)

plot(vuln_lt_bach_acs[order(estimate(vuln_lt_bach_acs)),1])
# plot(vuln_lt_bach_acs[order(standard.error(vuln_lt_bach_acs)),1])

```

```{r vuln-lt-bach-sf}

if(!file.exists(root_file('1-data/4-interim/vuln-lt-bach-sf.rds'))){
        # Read in the `sf` object and re-order the records to by `JOIN_ID` 
# -----------------------------------------------------------------------------

if(!exists('coo_geos_sf')){coo_geos_sf <- read_rds(root_file('1-data/4-interim/coo-geos-sf.rds'))}        
        
coo_geos_sf_ordered <- coo_geos_sf %>% arrange(JOIN_ID) %>% select(-JOIN_ID)

#
# Convert the `acs` object into a dataframe, join to sf object
# -----------------------------------------------------------------------------

coo_vuln_lt_bach_sf <- 
        data.frame(
                geography(vuln_lt_bach_acs)["NAME"],
                geography(vuln_lt_bach_acs)["tract"],
                estimate(vuln_lt_bach_acs), 
                1.645 * standard.error(vuln_lt_bach_acs)) %>% 
        `colnames<-`(., c("NAME","GEOID6", "LT_BACH_PCT_EST","LT_BACH_PCT_MOE")) %>% 
        mutate(JOIN_ID = case_when(.$NAME %in% 'King County, Washington' ~ 'KC',
                                  .$NAME %in% 'Seattle CCD, King County, Washington' ~ 'SEACCD',
                                  !is.na(.$GEOID6) ~ .$GEOID6),
               UPPER = LT_BACH_PCT_EST + LT_BACH_PCT_MOE, 
               LOWER = LT_BACH_PCT_EST - LT_BACH_PCT_MOE, 
               LT_BACH_PCT_UPPER = if_else(UPPER > 1, 1, UPPER), 
               LT_BACH_PCT_LOWER = if_else(LOWER < 0, 0, LOWER)) %>% 
        select(JOIN_ID,everything(),-NAME,-GEOID6,-UPPER,-LOWER) %>% 
        arrange(desc(JOIN_ID)) %>%
        bind_cols(coo_geos_sf_ordered) %>% 
        st_sf()

#
# Save the object
# -----------------------------------------------------------------------------
coo_vuln_lt_bach_sf %>% write_rds(root_file('1-data/4-interim/vuln-lt-bach-sf.rds'))
}

coo_vuln_lt_bach_sf <-  read_rds(root_file('1-data/4-interim/vuln-lt-bach-sf.rds'))


```

##### Seattle CCD 
```{r vuln-lt-bach-seaccd-map}

tr <- 
        coo_vuln_lt_bach_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL)

tr_comm <- 
        coo_vuln_lt_bach_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL &!is.na(NAME))

comm <- coo_vuln_lt_bach_sf %>% 
        filter(GEOGRAPHY == 'community')

comm_cntr <- comm %>% mutate(geometry = st_centroid(comm))

pal_lt_bach <- colorNumeric(viridis(256, option = "C"),tr$LT_BACH_PCT_EST)

myLfltGrey() %>% 
        addPolygons(data = as(tr,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_rent(LT_BACH_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "LESS THAN<br>BACH. DEGREE",
                  position = 'topright',
                  pal = pal_lt_bach, 
                  values = tr$LT_BACH_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

#####COO Communities
```{r vuln-lt-bach-comm-map}
myLfltGrey() %>% 
        addPolygons(data = as(tr_comm,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_lt_bach(LT_BACH_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "LESS THAN<br>BACH. DEGREE",
                  position = 'topright',
                  pal = pal_lt_bach, 
                  values = tr$LT_BACH_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

### Household earning less than 80% of the HUD , 2010-2014

This indicator is intended as a proxy for low-income households. There are many possible ways to determine whether a household fits this category, but one commonly-used metric is the area median income (AMI). Generally speaking, households earning less than 80% AMI are considered to be low-income households, as status which has implications for affordable housing eligibility. 

The Lisa Bates used a fairly precise dataset for this indicator: percent of households that have incomes at or below at or below 80% of the HUD-adjusted median family income (MFI). The data source is HUD's Consolidated Housing Affordability Strategy (CHAS) as used. Unfortunately, the [most recent CHAS data](https://www.huduser.gov/portal/datasets/cp/CHAS/data_download_chas.html) is based on the 2009-2013 ACS 5-year estimate. 

Rather than introduce an inconsistency in the observation periods of this assessment's datasets, this method uses an approximation of the 80% AMI metric using the ACS Household Income (B19001), 2010-2014 5-year estimate. This data is structured as household counts within a range of annual household income (e.g. $15,000 to $19,999). The FY 2015 MFI Estimate for Seattle-Bellevue, WA HUD Metro FMR Area is $89,500. In inflation-adjusted 2014 dollars that is $87,732.78, and 80% of that equals $70,200; which puts it within the `$60,000 to $74,999` range. Therefore, for this assessment any household with an annual income of $74,999 or less is considered to be low-income.

```{r vuln-low-inc-acs}

# Download the Census table for the project's geographies
# -----------------------------------------------------------------------------

if(!exists('coo_geo_acs')){coo_geo_acs <- read_rds(root_file('1-data/4-interim/coo-geo-acs.rds'))}

vuln_low_inc_tbl <- "B19001"  # census table code

if(!file.exists(root_file('1-data/4-interim/vuln-low-inc-orig-acs.rds'))){
        
        acs.fetch(endyear = 2014, geography = coo_geo_acs, 
                  table.number = vuln_low_inc_tbl) %>%
                write_rds(root_file('1-data/4-interim/vuln-low-inc-orig-acs.rds'))
        
}

vuln_low_inc_orig_acs <- read_rds(root_file('1-data/4-interim/vuln-low-inc-orig-acs.rds'))


# Process and save the data
# -----------------------------------------------------------------------------

if(!file.exists(root_file('1-data/4-interim/vuln-low-inc-acs.rds'))){
        vuln_low_inc_acs1 <- vuln_low_inc_orig_acs
        
        vuln_low_inc_tbl_guide <- 
                data.frame(terse = acs.colnames(vuln_low_inc_acs1),
                       pretty = acs.colnames(acs.fetch(endyear = 2014, 
                          geography = geo.make(us = TRUE), 
                          table.number = vuln_low_inc_tbl,col.names = 'pretty')))
        # Pull out the specific columns that are important
        
        get_col <- function(pattern){
                vuln_low_inc_tbl_guide %>% filter(str_detect(pretty,pattern)) %>% select(terse) %>% unlist(use.names = FALSE) %>% as.character()
        }
        
        total <- get_col('Total:')
        
        low_inc <- get_col('\\$10,|\\$14,|\\$19,|\\$24,|\\$29,|\\$34,|\\$39,|\\$44,|\\$49,|\\$59,|\\$74,')
        
        # Add all pops with bach. or higher
        
        acs_col_low_inc <- 
                acs::apply(X = vuln_low_inc_acs1[,low_inc],
                           MARGIN = 2,
                           FUN = sum,
                           verbose = FALSE)
        
        acs.colnames(acs_col_low_inc) <- "LOW_INC"
       
        # Find the proportion of renters to the Total population
        acs_col_pct_low_inc <-  
                acs::apply(X = acs_col_low_inc[,"LOW_INC"],
                           MARGIN = 1,
                           FUN = divide.acs,
                           denominator = vuln_low_inc_acs1[,total],
                           method = "proportion",
                           verbose = FALSE)
        
        acs.colnames(acs_col_pct_low_inc) <- 'PCT_LOW_INC'
        
        # Save the object

acs_col_pct_low_inc %>% saveRDS(root_file('1-data/4-interim/vuln-low-inc-acs.rds'))
}

vuln_low_inc_acs <- read_rds(root_file('1-data/4-interim/vuln-low-inc-acs.rds'))


# Plot the data
# -----------------------------------------------------------------------------

# plot(vuln_low_inc_acs)

plot(vuln_low_inc_acs[order(estimate(vuln_low_inc_acs)),1])
# plot(vuln_low_inc_acs[order(standard.error(vuln_low_inc_acs)),1])

```

```{r vuln-low-inc-sf}

if(!file.exists(root_file('1-data/4-interim/vuln-low-inc-sf.rds'))){
        # Read in the `sf` object and re-order the records to by `JOIN_ID` 
# -----------------------------------------------------------------------------

if(!exists('coo_geos_sf')){coo_geos_sf <- read_rds(root_file('1-data/4-interim/coo-geos-sf.rds'))}        
        
coo_geos_sf_ordered <- coo_geos_sf %>% arrange(JOIN_ID) %>% select(-JOIN_ID)

#
# Convert the `acs` object into a dataframe, join to sf object
# -----------------------------------------------------------------------------

coo_vuln_low_inc_sf <- 
        data.frame(
                geography(vuln_low_inc_acs)["NAME"],
                geography(vuln_low_inc_acs)["tract"],
                estimate(vuln_low_inc_acs), 
                1.645 * standard.error(vuln_low_inc_acs)) %>% 
        `colnames<-`(., c("NAME","GEOID6", "LOW_INC_PCT_EST","LOW_INC_PCT_MOE")) %>% 
        mutate(JOIN_ID = case_when(.$NAME %in% 'King County, Washington' ~ 'KC',
                                  .$NAME %in% 'Seattle CCD, King County, Washington' ~ 'SEACCD',
                                  !is.na(.$GEOID6) ~ .$GEOID6),
               UPPER = LOW_INC_PCT_EST + LOW_INC_PCT_MOE, 
               LOWER = LOW_INC_PCT_EST - LOW_INC_PCT_MOE, 
               LOW_INC_PCT_UPPER = if_else(UPPER > 1, 1, UPPER), 
               LOW_INC_PCT_LOWER = if_else(LOWER < 0, 0, LOWER)) %>% 
        select(JOIN_ID,everything(),-NAME,-GEOID6,-UPPER,-LOWER) %>% 
        arrange(desc(JOIN_ID)) %>%
        bind_cols(coo_geos_sf_ordered) %>% 
        st_sf()

#
# Save the object
# -----------------------------------------------------------------------------
coo_vuln_low_inc_sf %>% write_rds(root_file('1-data/4-interim/vuln-low-inc-sf.rds'))
}

coo_vuln_low_inc_sf <-  read_rds(root_file('1-data/4-interim/vuln-low-inc-sf.rds'))

```


##### Seattle CCD 
```{r vuln-low-inc-seaccd-map}

tr <- 
        coo_vuln_low_inc_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL)

tr_comm <- 
        coo_vuln_low_inc_sf %>% 
        filter(GEOGRAPHY == 'tract' & SEACCD_LGL &!is.na(NAME))

comm <- coo_vuln_low_inc_sf %>% 
        filter(GEOGRAPHY == 'community')

comm_cntr <- comm %>% mutate(geometry = st_centroid(comm))

pal_low_inc <- colorNumeric(viridis(256, option = "C"),tr$LOW_INC_PCT_EST)

myLfltGrey() %>% 
        addPolygons(data = as(tr,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_low_inc(LOW_INC_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "Low Income<br>Households",
                  position = 'topright',
                  pal = pal_low_inc, 
                  values = tr$LOW_INC_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

#####COO Communities
```{r vuln-low-inc-comm-map}
myLfltGrey() %>% 
        addPolygons(data = as(tr_comm,'Spatial'),
                fillOpacity = .75,
                fillColor = ~pal_low_inc(LOW_INC_PCT_EST),
                color = col2hex('white'),
                opacity = 1,
                weight = .5,
                smoothFactor = 0) %>%
        addPolygons(data = as(comm,'Spatial'),
                fillOpacity = 0,
                color = proj_dark_grey,
                opacity = 1,
                weight = 2,
                smoothFactor = 0) %>%
        addAwesomeMarkers(data = as(comm_cntr, "Spatial"),options = markerOptions(opacity = 0),label = ~ NAME_FULL, labelOptions = labelOptions(noHide = TRUE,direction = 'left', textOnly = TRUE)) %>% 
        addLegend(title = "Renters",
                  position = 'topright',
                  pal = pal_low_inc, 
                  values = tr$LOW_INC_PCT_EST,
                  opacity = .75,
                  labFormat = labelFormat(suffix = '%',transform = function(x) 100 * x)) %>% 
        styleWidget(style = "text-transform:uppercase;text-shadow:-1px 0 #FFFFFF,0 1px #FFFFFF,1px 0 #FFFFFF,0 -1px #FFFFFF")

```

