---
df_print: tibble
output:
  html_notebook:
    code_folding: hide
  pdf_document:
    keep_tex: yes
always_allow_html: yes
---

```{r misc-setup, echo = FALSE, warning=FALSE,message=FALSE,comment=FALSE}
library(magrittr)
library(operator.tools)
library(knitr)
library(rprojroot)
library(tidyverse)
library(rgdal)
library(sp)
library(rgeos)
library(miscgis)
library(tigris)
library(leaflet)
library(ggthemes)
library(stringr)
library(downloader)
library(miscgis)
library(sf)
root <- rprojroot::is_rstudio_project
root_file <- root$make_fix_file()
```

```{r misc-colors}
green <- miscgis::miscgis_pals$tableau_cat[["green"]]
blue <- miscgis::miscgis_pals$tableau_cat[["blue"]]
orange <- miscgis::miscgis_pals$tableau_cat[["orange"]]
red <- miscgis::miscgis_pals$tableau_cat[["red"]]
teal <- miscgis::miscgis_pals$tableau_cat[["teal"]]
pal_rgb_4 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue")] %>% unlist %>% palette()
pal_rgb_4 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue")] %>% unlist %>% palette()
pal_rgb_6 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue","orange","purple")] %>% unlist %>% palette()
pal_rgb_6 <- miscgis::miscgis_pals$tableau_cat[c("red","gold","green","blue","orange","purple")] %>% unlist %>% palette()
```

Below is a collection of spatial datasets used in this project.

### Seattle Boundary {-}

```{r misc-sea-bound, fig.cap="Seattle\'s geographic boundary"}

if(!file.exists(root_file('1-data/4-interim/seattle-sf.rds'))){
        tigris::places(state = "WA") %>%
                tigris::filter_place(place = "Seattle") %>%
                spTransform(CRSobj = crs_proj) %>% 
                st_as_sf() %>% 
                miscgis::coerce_to_geom(sf::st_multipolygon) %>% 
                write_rds(root_file('1-data/4-interim/seattle-sf.rds'))
        
}

sea_sf <- read_rds(root_file('1-data/4-interim/seattle-sf.rds'))

green <- miscgis::miscgis_pals$tableau_cat[["green"]]

myLfltGrey(data = as(sea_sf,'Spatial')) %>% 
        myLfltOpts() %>% 
        addPolygons(color = green,opacity = 1,fillColor = green,fillOpacity = .5)

```

### King County Subdivision Boundary {-}

```{r misc-sea-ccd, fig.cap="Seattle Subdivision of King County\'s geographic boundary"}

if(!file.exists(root_file('1-data/4-interim/seattle-ccd-sf.rds'))){
        tigris::county_subdivisions(state = "53",county = "033") %>% 
                subset(NAME == "Seattle") %>% 
                spTransform(CRSobj = crs_proj) %>% 
                st_as_sf() %>% 
                miscgis::coerce_to_geom(sf::st_multipolygon) %>% 
                write_rds(root_file('1-data/4-interim/seattle-ccd-sf.rds'))
}

sea_ccd_sf <- read_rds(root_file('1-data/4-interim/seattle-ccd-sf.rds'))

myLfltGrey(data = as(sea_ccd_sf,'Spatial')) %>% 
        myLfltOpts() %>% 
        addPolygons(color = blue,opacity = 1,fillColor = blue,fillOpacity = .5)

```

### Tracts in King County {-}
Although this assessment is primarily focused on three communities within the Seattle CCD subdivision of King County, one of the indicators (housing market conditions) uses neighboring tracts to determine displacement risk. Some of the neighboring tracts are part of other county subdivision, but rather than targeting just those specific tracts, this method collects data for all King County tracts and then runs the analysis on the appropriate subsets.

In the absence of a straight-forward method for identifying all the census tracts in the Seattle CCD subdivision of King County, it is possible to extract this information from [American Factfinder](https://factfinder.census.gov/faces/nav/jsf/pages/index.xhtml). This [tutorial](https://ask.census.gov/prweb/PRServletCustom?pyActivity=pyMobileSnapStart&Action=showHarness&Purpose=KMHelpSitePortal&className=Data-Portal&ReadOnly=true&pzMobileInitActivity=KMFetchArticleExternal&pzMobileInitActivityParams=%26ArticleID%3DKCP-3256&pzMobileContextPageName=pyDisplayHarness) describes how to use the American Factfinder interface to extract a list of all "all tracts within (or partially within) a census place"; substituting "county subdivision" for "place" will retrieve the desired results.

Tract boundaries sometimes change over time, particularly on years when the decennial census is conducted. While this project will primarily use the current set of boundaries, it is necessary to collect the tract boundaries of the 2000-2009 time period so that these datasets can be visually represented in choropleth diagrams.

```{r misc-tr-kc-wtr, fig.height=2, fig.width=2, fig.show='hold', dpi=150}
# 2015 tract boundaries
if(!file.exists(root_file('1-data/4-interim/tr-kc-wtr-2015-sf.rds'))){
        
        # Seattle CCD tracts 
        # Note: because this selection includes all tracts "within or partially-within" the Seattle CC,
        # several tract GEOIDs are duplicated in the selection. For the sake of clarity, these duplicates
        # are removed from the final vector of GEOIDs.
        tr_ccd_geoid_2012 <- 
                read_csv(
                        root_file('1-data/3-external/manual/seattle-ccd/ACS_12_5YR_B01001/ACS_12_5YR_B01001_with_ann.csv'), 
                        col_types = cols(Id2 = col_character()), 
                        skip = 1) %>% 
                mutate(NEW_GEOID1 = str_sub(Id2,1,5),
                       NEW_GEOID2 = str_sub(Id2,16,21),
                       GEOID = paste0(NEW_GEOID1,NEW_GEOID2),
                       UNIQUE = !duplicated(GEOID)) %>%
                filter(UNIQUE) %>% 
                extract2('GEOID')
        
        
        # All 2015 KC tracts with Seattle CCD subdivision column
        
        tigris::tracts(state = '53',county = '033', year = 2015) %>%
                spTransform(CRSobj = crs_proj) %>% 
                st_as_sf() %>% 
                st_cast('MULTIPOLYGON') %>% 
                mutate(SEACCD_LGL = ifelse(GEOID %in% tr_ccd_geoid_2012,TRUE,FALSE)) %>% 
                write_rds(root_file('1-data/4-interim/tr-kc-wtr-2015-sf.rds'))
              
}

# pre-2010 tract boundaries
if(!file.exists(root_file('1-data/4-interim/tr-kc-wtr-2009-sf.rds'))){
        
        # Seattle CCD tracts 
        # Note: because this selection includes all tracts "within or partially-within" the Seattle CC,
        # several tract GEOIDs are duplicated in the selection. For the sake of clarity, these duplicates
        # are removed from the final vector of GEOIDs.
        tr_ccd_geoid_2009 <- 
                read_csv(
                        root_file('1-data/3-external/manual/seattle-ccd/ACS_09_5YR_B01001/ACS_09_5YR_B01001_with_ann.csv'), 
                        col_types = cols(GEO.id2 = col_character())) %>% 
                mutate(NEW_GEOID1 = str_sub(GEO.id2,1,5),
                       NEW_GEOID2 = str_sub(GEO.id2,16,21),
                       GEOID = paste0(NEW_GEOID1,NEW_GEOID2),
                       UNIQUE = !duplicated(GEOID)) %>%
                filter(UNIQUE) %>% 
                extract2('GEOID')
        
        
        # All 2015 KC tracts with Seattle CCD subdivision column
        
        my_dl_zip <- function(url,dir_filepath){
                temp <- tempfile()
                downloader::download(url, dest = temp, mode='wb')
                unzip(temp, exdir = dir_filepath)
                
        }
        
        # my_dl_zip('ftp://ftp.census.gov/geo/tiger/TIGER2009/53_WASHINGTON/53033_King_County/tl_2009_53033_tract00.zip',root_file('1-data/3-external/manual/kc-tr/'))


        readOGR(dsn = root_file('./1-data/3-external/manual/kc-tr/tl_2009_53033_tract00/'),
                layer = 'tl_2009_53033_tract00',
                verbose = FALSE,
                stringsAsFactors = FALSE) %>% 
                spTransform(CRSobj = crs_proj) %>%
                st_as_sf() %>%
                st_cast('MULTIPOLYGON') %>% 
                mutate(SEACCD_LGL = ifelse(CTIDFP00 %in% tr_ccd_geoid_2009,TRUE,FALSE)) %>% 
                write_rds(root_file('1-data/4-interim/tr-kc-wtr-2009-sf.rds'))
                
        
        # Note: the `tigris` package is returning an error for attempts to
        # download tract data before 2011
        # tigris::tracts(state = '53',county = '033', year = 2009) %>%
        #         spTransform(CRSobj = crs_proj) %>%
        #         st_as_sf() %>%
        #         st_cast('MULTIPOLYGON') %>%
        #         mutate(SEACCD_LGL = ifelse(GEOID %in% tr_ccd_geoid_2012,TRUE,FALSE)) %>%
        #         write_rds(root_file('1-data/4-interim/tr-kc-wtr-2009-sf.rds'))
        
}


tr_kc_wtr_2015_sf <- read_rds(root_file('1-data/4-interim/tr-kc-wtr-2015-sf.rds'))

tr_kc_wtr_2009_sf <- read_rds(root_file('1-data/4-interim/tr-kc-wtr-2009-sf.rds'))

show_tr_ccd_wtr_2009_sf <- function(){
        
        blue_orange <- c(blue,orange) %>% unlist
        
        pal <- colorFactor(blue_orange,levels = c(TRUE,FALSE), ordered = TRUE)
        
        myLfltGrey() %>% 
                myLfltOpts() %>% 
                addPolygons(data = as(tr_kc_wtr_2009_sf,"Spatial"),
                            weight = .5,
                            color = ~ pal(SEACCD_LGL),
                            opacity = 1,
                            fillColor = ~ pal(SEACCD_LGL),
                            fillOpacity = .5) %>% 
                addLegend(position = 'bottomright',colors = blue_orange,labels = c('Seattle CCD','Other Tracts'),title = 'pre-2010') %>% 
                miscgis::styleWidget(style = "float:left;margin:1px")
}
show_tr_ccd_wtr_2015_sf <- function(){
        
        blue_orange <- c(blue,orange) %>% unlist
        
        pal <- colorFactor(blue_orange,levels = c(TRUE,FALSE), ordered = TRUE)
        
        myLfltGrey() %>% 
                myLfltOpts() %>% 
                addPolygons(data = as(tr_kc_wtr_2015_sf,"Spatial"),
                            weight = .5,
                            color = ~ pal(SEACCD_LGL),
                            opacity = 1,
                            fillColor = ~ pal(SEACCD_LGL),
                            fillOpacity = .5) %>% 
                addLegend(position = 'bottomright',colors = blue_orange,labels = c('Seattle CCD','Other Tracts'),title = '2010') %>% 
                miscgis::styleWidget(style = "float:none;margin:1px")
}


show_tr_ccd_wtr_2009_sf()
show_tr_ccd_wtr_2015_sf()


```

### Puget Sound Waterbodies {-}

These are useful for "clipping" census geographies whose boundaries extend into waterbodies.

```{r misc-wtr, fig.cap="Puget Sound waterbodies"}

if(!file.exists(root_file('1-data/4-interim/wtr-sf.rds'))){
        fp_wtr <- root_file('1-data/3-external/NHDMajor.gdb')

# check if the file already exists, if not then download it
if(!file.exists(fp_wtr)){
        
        url <- "ftp://www.ecy.wa.gov/gis_a/inlandWaters/NHD/NHDmajor.gdb.zip" # save the URL for the waterbodies data
        
        temp <- tempfile() # create a temporary file to hold the compressed download
        
        download(url, dest = temp, mode="wb") # download the file
        
        unzip (temp, exdir = root_file('1-data/3-external/')) # extract the ESRI geodatabase file to a project folder
}

wtr_sp <-
        suppressWarnings(readOGR(dsn = fp_wtr,      # create a waterbodies shape
                layer = "NHD_MajorWaterbodies",verbose = FALSE,pointDropZ = TRUE)) %>%
        gBuffer(byid=TRUE, width=0) %>% # clean up self-intersecting polygons
        spTransform(CRSobj = crs_proj)  # transform the projection to match the project projection
wtr_sf <-  
        wtr_sp %>% 
        st_as_sf() %>% 
        miscgis::coerce_to_geom(st_multipolygon)

wtr_sf %>% 
        st_intersects(x = sea_ccd_sf,y = .) %>% 
        unlist(use.names = F) %>% 
        wtr_sf[.,] %>% 
        write_rds(root_file('1-data/4-interim/wtr-sf.rds'))
}

wtr_sf <- read_rds(root_file('1-data/4-interim/wtr-sf.rds'))

show_wtr <- function(){
        myLfltGrey(data = as(wtr_sf,'Spatial')) %>% 
                myLfltOpts() %>% 
                addPolygons(color = blue, opacity = 1, 
                            weight = .5, fillColor = blue,fillOpacity = .5)        
}

show_wtr()

```

### KC Tracts Without (Western) Waterbodies {-}
```{r misc-tracts-ccd-no-wtr, fig.height=2, fig.width=2, fig.show='hold', dpi=150}

if(!file.exists(root_file('1-data/4-interim/tr-kc-2015-sf.rds'))){
        tr_kc_wtr_2015_sf %>% 
                filter(TRACTCE %!in% '990100') %>% # remove the Puget Sound tract
                mutate(geometry = st_difference(geometry,st_union(wtr_sf))) %>% 
                coerce_to_geom(st_multipolygon) %>% 
                write_rds(root_file('1-data/4-interim/tr-kc-2015-sf.rds'))
}

if(!file.exists(root_file('1-data/4-interim/tr-kc-2009-sf.rds'))){
        tr_kc_wtr_2009_sf %>% 
                filter(TRACTCE00 %!in% '990100') %>% # remove the Puget Sound tract
                mutate(geometry = st_difference(geometry,st_union(wtr_sf))) %>% 
                coerce_to_geom(st_multipolygon) %>% 
                write_rds(root_file('1-data/4-interim/tr-kc-2009-sf.rds'))
}


tr_kc_2015_sf <- read_rds(root_file('1-data/4-interim/tr-kc-2015-sf.rds'))

tr_kc_2009_sf <- read_rds(root_file('1-data/4-interim/tr-kc-2009-sf.rds'))

show_tr_kc_2009_sf <- function(){
        
        blue_orange <- c(blue,orange) %>% unlist
        
        pal <- colorFactor(blue_orange,levels = c(TRUE,FALSE), ordered = TRUE)
        
        myLfltGrey() %>% 
                myLfltOpts() %>% 
                addPolygons(data = as(tr_kc_2009_sf,"Spatial"),
                            weight = .5,
                            color = ~ pal(SEACCD_LGL),
                            opacity = 1,
                            fillColor = ~ pal(SEACCD_LGL),
                            fillOpacity = .5) %>% 
                addLegend(position = 'bottomright',colors = blue_orange,labels = c('Seattle CCD','Other Tracts'),title = 'pre-2010') %>% 
                miscgis::styleWidget(style = "float:left;margin:1px")
}

show_tr_kc_2015_sf <- function(){
        
        blue_orange <- c(blue,orange) %>% unlist
        
        pal <- colorFactor(blue_orange,levels = c(TRUE,FALSE), ordered = TRUE)
        
        myLfltGrey() %>% 
                myLfltOpts() %>% 
                addPolygons(data = as(tr_kc_2015_sf,"Spatial"),
                            weight = .5,
                            color = ~ pal(SEACCD_LGL),
                            opacity = 1,
                            fillColor = ~ pal(SEACCD_LGL),
                            fillOpacity = .5) %>% 
                addLegend(position = 'bottomright',colors = blue_orange,labels = c('Seattle CCD','Other Tracts'),title = '2010') %>% 
                miscgis::styleWidget(style = "float:none;margin:1px")
}

show_tr_kc_2009_sf()

show_tr_kc_2015_sf()



```

