---
title: "_Dataset_ | Census Tracts"
author: "Tiernan Martin, [Futurewise](http://www.futurewisewa.org/)"
df_print: tibble
output:
  html_notebook: default
  pdf_document:
    keep_tex: yes
subtitle: Communities of Opportunity Displacement Risk Assessment
always_allow_html: yes
---

###Introduction
The primary geographic unit of this assessment is the [census tract](https://www.census.gov/geo/reference/gtc/gtc_ct.html). As is the case with many communities, the census geographies do not coincide exactly with the formal geographic boundary of the study's three sites, and should be considered as _spatial approximations_ of these communities.

Listed below are the geographic identifiers of the census tracts that approximate each site.



```{r, echo = FALSE, results="asis", warning=FALSE,message=FALSE}
library(tidyverse)
library(webshot)
library(knitr)
library(tigris)
library(miscgis)

# Rainier Valley
rv <- c("53033010001", "53033010300", "53033010401", "53033011001", "53033011002", "53033011101","53033011102", "53033011700", "53033011800", "53033011900")

# White Center
wc <- c("53033026600","53033026700","53033026500","53033026801","53033026802","53033027000")

# SeaTac/Tukwila

stc_hus <- read_csv("./1_raw/seatac_hus/DEC_10_SF1_H1_with_ann.csv", 
                    col_types = cols(Id2 = col_character()), skip = 1)

stc <-  paste(substr(x = stc_hus$Id2,1,2),substr(x = stc_hus$Id2,8,16),sep = "")

df <- miscgis::cbind_fill(rv,wc,stc) %>% 
        as_tibble() %>% 
        `colnames<-`(c("Rainier Valley",
                       "White Center",
                       "SeaTac/Tukwila"))

knitr::kable(df,caption = "Census Tract GEOIDs")
```

###Spatial Polygons

####With Waterbodies
Left to right: Rainier Valley, White Center, SeaTac/Tukwila
<br></br>

```{r, echo=FALSE,message=FALSE,fig.height=1.25, fig.width=1,  fig.show='hold', dpi=150,fig.cap='Rainier Valley, White Center, and SeaTac/Tukwila'}

library(htmltools)
library(htmlwidgets)
library(leaflet)
library(gplots)
library(ggmap)
library(rgeos)
library(sp)
library(magrittr)


tr <- tigris::tracts(state = "WA",county = "King", year = 2014)

tr_sel <- tr[tr$GEOID %in% c(rv,wc,stc),] %>% spTransform(CRSobj = crs_proj)

tr_sp <- tr_sel

tr_sp@data %<>% mutate(COO_SITE = case_when(.$GEOID %in% rv ~ "Rainier Valley",
                                            .$GEOID %in% wc ~ "White Center",
                                            .$GEOID %in% stc ~ "SeaTac/Tukwila"))

if(!file.exists("./2_intermediate/tr_sp_withwater.gpkg")){
writeOGR(obj = tr_sp,
         dsn = "./2_intermediate/tr_sp_withwater.gpkg",
         layer = "tr_sp_withwater",
         driver =  "GPKG",
         verbose = FALSE,
         overwrite_layer = TRUE)
}

cntr <- tr_sp %>% gCentroid(byid = TRUE) %>% gCentroid()

blue <- miscgis::miscgis_pals$tableau_cat[["blue"]]
green <- miscgis::miscgis_pals$tableau_cat[["green"]]
red <- miscgis::miscgis_pals$tableau_cat[["red"]]


# Rainier Valley
        
rv_map <- miscgis::myLfltGrey() %>%
        addPolygons(data = tr_sp[tr_sp$COO_SITE == "Rainier Valley",],
                    smoothFactor = 0,
                    color = col2hex("white"),
                    weight = .5,
                    opacity = 1,
                    fillColor = blue,
                    fillOpacity = .65
        ) %>% 
        setView(cntr$x,cntr$y,zoom = 9) %>% 
        miscgis::styleWidget(style = "float:left;margin:1px")



# White Center


wc_map <- miscgis::myLfltGrey() %>%
        addPolygons(data = tr_sp[tr_sp$COO_SITE == "White Center",],
                    smoothFactor = 0,
                    color = col2hex("white"),
                    weight = .5,
                    opacity = 1,
                    fillColor = green,
                    fillOpacity = .65
        ) %>% 
        setView(cntr$x,cntr$y,zoom = 9) %>% 
        miscgis::styleWidget(style = "float:left;margin:1px")

# SeaTac/Tukwila

stc_map <- miscgis::myLfltGrey() %>%
        addPolygons(data = tr_sp[tr_sp$COO_SITE == "SeaTac/Tukwila",],
                    smoothFactor = 0,
                    color = col2hex("white"),
                    weight = .5,
                    opacity = 1,
                    fillColor = red,
                    fillOpacity = .65
        ) %>% 
        setView(cntr$x,cntr$y,zoom = 9) %>% 
        miscgis::styleWidget(style = "float:none;margin:1px")

rv_map
wc_map
stc_map


```


####Without Waterbodies
Left to right: Rainier Valley, White Center, SeaTac/Tukwila
<br></br>

```{r, echo=FALSE,message=FALSE,fig.height=1.25, fig.width=1,  fig.show='hold', dpi=150,fig.cap='Rainier Valley, White Center, and SeaTac/Tukwila'}

library(rgdal)
library(magrittr)
library(shiny)

wtr <- readOGR(dsn = "./2_intermediate/wtr_sp.gpkg", 
          layer = "wtr_sp",verbose = FALSE) %>% gUnaryUnion(.) %>% spTransform(CRSobj = crs_proj)

tr_trim_sp <- spClip(tr_sp,wtr)

if(!file.exists("./2_intermediate/tr_trim_sp.gpkg")){
        writeOGR(obj = tr_trim_sp,
         dsn = "./2_intermediate/tr_trim_sp.gpkg",
         layer = "tr_trim_sp",driver = "GPKG",
         verbose = FALSE,
         overwrite_layer = TRUE)
}

# Individiaul Maps

rv_trim <- tr_trim_sp %>% subset(COO_SITE == "Rainier Valley")

wc_trim <- tr_trim_sp %>% subset(COO_SITE == "White Center")

stc_trim <- tr_trim_sp %>% subset(COO_SITE == "SeaTac/Tukwila")


# Rainier Valley
        
rv_trim_map <- miscgis::myLfltGrey() %>%
        addPolygons(data = rv_trim,
                    smoothFactor = 0,
                    color = col2hex("white"),
                    weight = .5,
                    opacity = 1,
                    fillColor = blue,
                    fillOpacity = .65
        ) %>% 
        setView(cntr$x,cntr$y,zoom = 9) %>% 
        miscgis::styleWidget(style = "float:left;margin:1px")



# White Center

wc_trim_map <- miscgis::myLfltGrey() %>%
        addPolygons(data = wc_trim,
                    smoothFactor = 0,
                    color = col2hex("white"),
                    weight = .5,
                    opacity = 1,
                    fillColor = green,
                    fillOpacity = .65
        ) %>% 
        setView(cntr$x,cntr$y,zoom = 9) %>% 
        miscgis::styleWidget(style = "float:left;margin:1px")

# SeaTac/Tukwila

stc_trim_map <- miscgis::myLfltGrey() %>%
        addPolygons(data = stc_trim,
                    smoothFactor = 0,
                    color = col2hex("white"),
                    weight = .5,
                    opacity = 1,
                    fillColor = red,
                    fillOpacity = .65
        ) %>% 
        setView(cntr$x,cntr$y,zoom = 9) %>% 
        miscgis::styleWidget(style = "float:none;margin:1px")

rv_trim_map

wc_trim_map

stc_trim_map



```

```{r, echo=FALSE,message=FALSE, dpi = 150}
# Combined map 

pal_rgb <- miscgis_pals$tableau_cat[c("blue","green","red")] %>% unlist %>% palette()

pal <- colorFactor(pal_rgb,domain = factor(tr_trim_sp$COO_SITE,levels = c("Rainier Valley",
                                                                          "White Center",
                                                                          "SeaTac/Tukwila")))
pts <- gCentroid(tr,byid = TRUE) %>% spTransform(crs_proj) %>% 
        SpatialPointsDataFrame(data = tr@data,match.ID = FALSE)

popups <- paste0(tr_trim_sp@data$GEOID)

leaflet() %>%
        addProviderTiles(providers$CartoDB.Positron) %>% 
        addPolygons(data = tr_trim_sp,
                    smoothFactor = 0,
                    color = col2hex("white"),
                    weight = .5,
                    opacity = 1,
                    fillColor = ~pal(COO_SITE),
                    fillOpacity = .65,
                    group = "COO Sites") %>% 
        addPolygons(data = tr,
                    smoothFactor = 0,
                    weight = .75,
                    color = col2hex("grey50"),
                    opacity = .75,
                    fillOpacity = 0,
                    group = "All Tracts", popup = popups) %>%
        setView(cntr$x,cntr$y,zoom = 11) %>% 
        addLayersControl(baseGroups = "COO Sites",overlayGroups = "All Tracts") %>% 
        addLegend(title = "COO Sites",
                  position = "topright",
                  pal = pal,
                  values = tr_trim_sp$COO_SITE) %>% 
        saveWidget(file = "tr_coo_sites.html",selfcontained = FALSE,libdir = "./2_intermediate/html_support_files")
                



```

####Links to Fullscreen Maps
* [All three sites]()
* [Rainier Valley]()
* [White Center]()
* [SeaTac/Tukwila]()


